<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTWG Grade Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        /* Constants and Theme */
        :root {
            --accent-color: #0065bd;
            --background-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --border-radius: 8px;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--accent-color);
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: 300;
        }

        .header-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .github-link {
            display: inline-block;
            margin-top: 10px;
            color: var(--accent-color);
            text-decoration: none;
            font-size: 0.9rem;
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        .github-link:hover {
            background-color: var(--accent-color);
            color: white;
            transform: translateY(-1px);
        }

        .control-bar {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .file-input-container {
            margin-bottom: 20px;
        }

        .file-input-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--accent-color);
        }

        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            background: #f9f9f9;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        input[type="file"]:hover {
            border-color: var(--accent-color);
        }

        /* Phase 2 - Slider Controls */
        .sliders-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .slider-group {
            display: flex;
            flex-direction: column;
        }

        .slider-group label {
            font-weight: 500;
            color: var(--accent-color);
            margin-bottom: 8px;
        }

        .slider-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .slider-input {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            color: var(--accent-color);
            background: #f0f8ff;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            font-size: 14px;
        }

        .slider-input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: white;
        }

        /* Phase 2 - Summary Panel */
        .summary-container {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .summary-container h2 {
            margin-bottom: 15px;
            color: var(--accent-color);
            font-size: 1.5rem;
            font-weight: 400;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-color);
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* Phase 3 - Charts Panel */
        .charts-container {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .charts-container h2 {
            margin-bottom: 20px;
            color: var(--accent-color);
            font-size: 1.5rem;
            font-weight: 400;
            text-align: center;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .chart-panel {
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .table-container {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .table-container h2 {
            margin-bottom: 15px;
            color: var(--accent-color);
            font-size: 1.5rem;
            font-weight: 400;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--accent-color);
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .computed-column {
            background-color: #f0f8ff;
            font-weight: 500;
        }

        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: var(--border-radius);
            padding: 10px;
            margin: 10px 0;
        }

        .info {
            color: #0c5460;
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: var(--border-radius);
            padding: 10px;
            margin: 10px 0;
        }

        .scrollable-table {
            max-height: 600px;
            overflow-y: auto;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .sliders-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .chart-wrapper {
                height: 300px;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px;
            }
        }

        /* Phase 4 - ID Matching */
        .id-matching-container {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .id-matching-container h2 {
            margin-bottom: 20px;
            color: var(--accent-color);
            font-size: 1.5rem;
            font-weight: 400;
        }

        .id-input-group {
            margin-bottom: 15px;
        }

        .id-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--accent-color);
        }

        #student-ids {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            background: #f9f9f9;
        }

        #student-ids:focus {
            outline: none;
            border-color: var(--accent-color);
            background: white;
        }

        .id-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--accent-color);
            color: white;
        }

        .action-btn:hover {
            background: #004a9f;
            transform: translateY(-1px);
        }

        .action-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.copy-all-btn {
            background: #28a745;
        }

        .action-btn.copy-all-btn:hover {
            background: #218838;
        }

        /* ID Match Table */
        .id-match-container {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .id-match-container h2 {
            margin-bottom: 15px;
            color: var(--accent-color);
            font-size: 1.5rem;
            font-weight: 400;
        }

        .not-found-row {
            opacity: 0.5;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.05) 2px,
                rgba(0, 0, 0, 0.05) 4px
            );
        }

        .not-found-row td {
            color: #666;
            font-style: italic;
        }

        /* Responsive design for ID matching */
        @media (max-width: 768px) {
            .id-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .action-btn {
                width: 100%;
            }
        }

        /* Phase 5 - Alignment Statistics */
        .id-match-stats {
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .id-match-stats h3 {
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .excel-formula-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
        }

        .excel-formula-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: white;
        }

        .excel-formula-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 101, 189, 0.1);
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-item {
                padding: 10px;
            }
            
            .stat-value {
                font-size: 1.2rem;
            }
            
            /* Phase 7 - Responsive button layout */
            .action-btn {
                flex: 1;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1>HTWG Grade Calculator</h1>
            <a href="https://github.com/oduerr/grader" target="_blank" class="github-link">
                📁 View on GitHub
            </a>
        </div>
        
        <div class="control-bar">
            <div class="file-input-container">
                <label for="grading-file">Upload Grading Excel File (.xlsx)</label>
                <input type="file" id="grading-file" accept=".xlsx" />
            </div>
            
            <!-- Phase 2: Interactive sliders -->
            <div class="sliders-container" id="sliders-container" style="display: none;">
                <div class="slider-group">
                    <label for="p4-slider">P4 Threshold (Points for Grade 4.0)</label>
                    <div class="slider-wrapper">
                        <input type="range" id="p4-slider" min="5" max="50" value="10" step="0.5">
                        <input type="number" id="p4-input" class="slider-input" min="5" max="50" value="10" step="0.5">
                    </div>
                    <small id="p4-range-info" style="color: #666; font-size: 0.8em;"></small>
                </div>
                <div class="slider-group">
                    <label for="p1-slider">P1 Threshold (Points for Grade 1.0)</label>
                    <div class="slider-wrapper">
                        <input type="range" id="p1-slider" min="10" max="100" value="20" step="0.5">
                        <input type="number" id="p1-input" class="slider-input" min="10" max="100" value="20" step="0.5">
                    </div>
                    <small id="p1-range-info" style="color: #666; font-size: 0.8em;"></small>
                </div>
            </div>
        </div>

        <!-- Phase 2: Summary Panel -->
        <div id="summary-container" class="summary-container" style="display: none;">
            <h2>Grading Summary</h2>
            <div class="summary-stats">
                <div class="stat-item">
                    <span class="stat-value" id="average-grade">--</span>
                    <div class="stat-label">Average Grade</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="pass-rate">--</span>
                    <div class="stat-label">Pass Rate (&lt; 4.15)</div>
                </div>
            </div>
        </div>

        <!-- Phase 3: Charts Panel -->
        <div id="charts-container" class="charts-container" style="display: none;">
            <h2>Grade Distribution Analysis</h2>
            <div class="charts-grid">
                <div class="chart-panel">
                    <div class="chart-title">ECDF of Points (pkt)</div>
                    <div class="chart-wrapper">
                        <canvas id="ecdf-chart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <div class="chart-title">Grade Frequency Distribution</div>
                    <div class="chart-wrapper">
                        <canvas id="histogram-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="grading-table-container" class="table-container" style="display: none;">
            <h2>Grading Table</h2>
            <div id="grading-table-content"></div>
        </div>

        <!-- Phase 4: ID Matching & University Submission -->
        <div id="id-matching-container" class="id-matching-container" style="display: none;">
            <h2>University Submission Workflow</h2>
            <div class="id-input-group">
                <label for="student-ids">Paste Student IDs (one per line, in order from university Excel)</label>
                <textarea id="student-ids" placeholder="12345&#10;67890&#10;13579&#10;..."></textarea>
                <small style="color: #666; font-size: 0.9em;">
                    Copy the student ID column from your official university Excel file and paste it here. 
                    The grades will be reordered to match this sequence and copied to clipboard.
                </small>
            </div>
            <div class="id-actions">
                <button id="process-and-copy-btn" class="action-btn">Process ID Order</button>
            </div>
        </div>

        <!-- Phase 4: ID Match Table -->
        <div id="id-match-container" class="id-match-container" style="display: none;">
            <h2>Grade Alignment (University Excel Order)</h2>
            <div id="id-match-content"></div>
            
            <!-- Phase 5: Grade Alignment Statistics -->
            <div id="id-match-stats" class="id-match-stats" style="display: none; margin-top: 20px;">
                <h3>Alignment Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="alignment-mean">--</span>
                        <div class="stat-label">Mean Grade</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="alignment-pass-rate">--</span>
                        <div class="stat-label">Pass Rate</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="alignment-pass-count">--</span>
                        <div class="stat-label">Students Passed</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="alignment-checksum">--</span>
                        <div class="stat-label">Checksum</div>
                    </div>
                </div>
                
                <div class="excel-formula-section" style="margin-top: 15px;">
                    <label for="excel-formula" style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--accent-color);">
                        Excel Checksum Formula (copy & paste):
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="excel-formula" readonly class="excel-formula-input" value="=AVERAGE(F6:F20 * G6:G20)">
                        <button id="copy-formula-btn" class="action-btn" style="padding: 5px 10px; font-size: 0.9rem;">Copy Formula</button>
                    </div>
                    <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">
                        Adjust cell ranges (F6:F20, G6:G20) to match your Excel data. F=Student IDs, G=Grades.
                    </small>
                </div>
            </div>
            
            <div style="margin-top: 15px; margin-bottom: 15px;">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <button id="copy-aligned-grades-btn" class="action-btn" style="display: none;">Copy Grades to Clipboard</button>
                    <button id="copy-all-data-btn" class="action-btn copy-all-btn" style="display: none;" title="Copy both Student IDs and Grades for archival">Copy All to Clipboard</button>
                </div>
                <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">
                    "Copy All" includes both Student IDs and Grades in tab-separated format for easy pasting into Excel or saving as reference.
                </small>
            </div>
            <div style="margin-top: 15px; color: #666; font-size: 0.9em;">
                <em>Rows marked with stripes indicate student IDs not found in the grading data.</em>
            </div>
        </div>

        <div id="error-container"></div>
    </div>

    <script>
        // Constants - All thresholds and mappings defined here for maintainability
        const GRADE_CONSTANTS = {
            // Default thresholds (will be configurable in later phases)
            DEFAULT_P1: 20,  // Points for grade 1.0
            DEFAULT_P4: 10,  // Points for grade 4.0
            
            // Grade mapping intervals (based on F4 specification)
            GRADE_MAPPING: [
                { max: 1.15, grade: 100 },
                { max: 1.50, grade: 130 },
                { max: 1.85, grade: 170 },
                { max: 2.15, grade: 200 },
                { max: 2.50, grade: 230 },
                { max: 2.85, grade: 270 },
                { max: 3.15, grade: 300 },
                { max: 3.50, grade: 330 },
                { max: 3.85, grade: 370 },
                { max: 4.15, grade: 400 },
                { max: Infinity, grade: 500 }
            ]
        };

        // Global variables
        let gradingData = [];
        let currentP1 = GRADE_CONSTANTS.DEFAULT_P1;
        let currentP4 = GRADE_CONSTANTS.DEFAULT_P4;
        
        // Phase 3 - Chart instances
        let ecdfChart = null;
        let histogramChart = null;
        
        // Phase 4 - ID matching
        let studentIdList = [];
        let alignedGradeData = [];

        // Initialize slider values on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('p1-slider').value = currentP1;
            document.getElementById('p1-input').value = currentP1;
            document.getElementById('p4-slider').value = currentP4;
            document.getElementById('p4-input').value = currentP4;
        });

        // F1 - File upload handler
        document.getElementById('grading-file').addEventListener('change', handleFileUpload);

        // Phase 2 - Slider event listeners
        document.getElementById('p1-slider').addEventListener('input', handleSliderChange);
        document.getElementById('p4-slider').addEventListener('input', handleSliderChange);
        
        // Phase 5 - Number input event listeners
        document.getElementById('p1-input').addEventListener('input', handleInputChange);
        document.getElementById('p4-input').addEventListener('input', handleInputChange);

        // Phase 4 - ID matching event listener
        document.getElementById('process-and-copy-btn').addEventListener('click', handleProcessAndCopy);
        document.getElementById('copy-aligned-grades-btn').addEventListener('click', handleCopyAlignedGrades);
        
        // Phase 7 - Copy all data event listener
        document.getElementById('copy-all-data-btn').addEventListener('click', handleCopyAllData);
        
        // Phase 5 - Copy formula event listener
        document.getElementById('copy-formula-btn').addEventListener('click', handleCopyFormula);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            clearErrors();

            if (!file.name.endsWith('.xlsx')) {
                showError('Please select an Excel file (.xlsx)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showError('Excel file must contain at least a header row and one data row');
                        return;
                    }

                    processGradingData(jsonData);
                } catch (error) {
                    showError('Error reading Excel file: ' + error.message);
                }
            };
            reader.readAsBinaryString(file);
        }

        function processGradingData(rawData) {
            try {
                const headers = rawData[0];
                
                // Validate that first column is mtknr
                if (!headers[0] || headers[0].toLowerCase() !== 'mtknr') {
                    showError('First column must be "mtknr" (student ID)');
                    return;
                }

                // Process data rows
                gradingData = [];
                for (let i = 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    if (!row || row.length === 0) continue; // Skip empty rows
                    
                    const studentData = {
                        mtknr: row[0],
                        taskScores: [],
                        originalRow: row
                    };

                    // Extract numeric task scores (columns 1 onwards)
                    for (let j = 1; j < headers.length; j++) {
                        const score = parseFloat(row[j]);
                        if (!isNaN(score)) {
                            studentData.taskScores.push(score);
                        }
                    }

                    if (studentData.mtknr) {
                        gradingData.push(studentData);
                    }
                }

                if (gradingData.length === 0) {
                    showError('No valid student data found in the Excel file');
                    return;
                }

                // Calculate grades and display table
                calculateGrades();
                displayGradingTable(headers);
                
                // Phase 2: Set dynamic slider ranges based on data
                setSliderRanges();
                
                // Recalculate with new default thresholds and update display
                calculateGrades();
                updateGradingTable();
                
                // Show sliders and summary after data is loaded
                document.getElementById('sliders-container').style.display = 'grid';
                document.getElementById('summary-container').style.display = 'block';
                document.getElementById('charts-container').style.display = 'block'; // Phase 3: Show charts
                document.getElementById('id-matching-container').style.display = 'block'; // Phase 4: Show ID matching
                updateSummaryStats();
                updateCharts(); // Phase 3: Create initial charts
                
                showInfo('Successfully loaded ' + gradingData.length + ' students from the Excel file');

            } catch (error) {
                showError('Error processing grading data: ' + error.message);
            }
        }

        // F2, F3, F4 - Point aggregation, linear interpolation, and discrete grade mapping
        function calculateGrades() {
            gradingData.forEach(student => {
                // F2 - Point aggregation
                student.pkt = student.taskScores.reduce((sum, score) => sum + score, 0);
                
                // F3 - Linear interpolation (raw note 1.0 - 6.0)
                student.raw_note = calculateRawNote(student.pkt, currentP1, currentP4);
                
                // F4 - Discrete grade mapping
                student.grade = mapToDiscreteGrade(student.raw_note);
            });
        }

        // Phase 2 - F5: Slider change handler
        function handleSliderChange(event) {
            const sliderId = event.target.id;
            const value = parseFloat(event.target.value);
            
            if (sliderId === 'p1-slider') {
                currentP1 = value;
                document.getElementById('p1-input').value = value;
                
                // Ensure P1 > P4 for valid linear interpolation
                const p4Slider = document.getElementById('p4-slider');
                const p4Input = document.getElementById('p4-input');
                const p4Max = parseFloat(p4Slider.max);
                const newP4Max = Math.min(p4Max, currentP1 - 0.5);
                
                if (currentP4 >= currentP1) {
                    currentP4 = Math.max(parseFloat(p4Slider.min), newP4Max);
                    p4Slider.value = currentP4;
                    p4Input.value = currentP4;
                }
                // Update P4 slider max to ensure P4 < P1
                p4Slider.max = newP4Max;
                p4Input.max = newP4Max;
                document.getElementById('p4-range-info').textContent = `Range: ${p4Slider.min}-${newP4Max} points`;
                
            } else if (sliderId === 'p4-slider') {
                currentP4 = value;
                document.getElementById('p4-input').value = value;
                
                // Ensure P1 > P4 for valid linear interpolation
                const p1Slider = document.getElementById('p1-slider');
                const p1Input = document.getElementById('p1-input');
                const p1Min = parseFloat(p1Slider.min);
                const newP1Min = Math.max(p1Min, currentP4 + 0.5);
                
                if (currentP1 <= currentP4) {
                    currentP1 = Math.min(parseFloat(p1Slider.max), newP1Min);
                    p1Slider.value = currentP1;
                    p1Input.value = currentP1;
                }
                // Update P1 slider min to ensure P1 > P4
                p1Slider.min = newP1Min;
                p1Input.min = newP1Min;
                document.getElementById('p1-range-info').textContent = `Range: ${newP1Min}-${p1Slider.max} points`;
            }
            
            // Recalculate grades if data is loaded
            if (gradingData.length > 0) {
                calculateGrades();
                updateGradingTable();
                updateSummaryStats();
                updateCharts(); // Phase 3: Update charts
            }
        }

        // Phase 2 - F8: Calculate and display summary statistics
        function updateSummaryStats() {
            if (gradingData.length === 0) return;
            
            // Calculate average grade
            const totalGrades = gradingData.reduce((sum, student) => sum + student.grade, 0);
            const averageGrade = totalGrades / gradingData.length;
            
            // Calculate pass rate (grade < 4.15)
            const passCount = gradingData.filter(student => student.grade < 4.15).length;
            const passRate = (passCount / gradingData.length) * 100;
            
            // Update display
            document.getElementById('average-grade').textContent = averageGrade.toFixed(2);
            document.getElementById('pass-rate').textContent = passRate.toFixed(1) + '%';
        }

        // Update only the table data (keep headers)
        function updateGradingTable() {
            const tableBody = document.querySelector('#grading-table-content tbody');
            if (!tableBody) return;
            
            let tableHTML = '';
            gradingData.forEach(student => {
                tableHTML += '<tr>';
                
                // Original data columns
                student.originalRow.forEach(value => {
                    tableHTML += `<td>${value !== undefined ? value : ''}</td>`;
                });
                
                // Computed columns
                tableHTML += `<td class="computed-column">${student.pkt.toFixed(1)}</td>`;
                tableHTML += `<td class="computed-column">${student.raw_note.toFixed(2)}</td>`;
                tableHTML += `<td class="computed-column">${student.grade.toFixed(1)}</td>`;
                
                tableHTML += '</tr>';
            });
            
            tableBody.innerHTML = tableHTML;
        }

        // Phase 3 - F6: Create ECDF chart of points
        function createECDFChart() {
            if (gradingData.length === 0) return;
            
            // Sort points for ECDF calculation
            const points = gradingData.map(student => student.pkt).sort((a, b) => a - b);
            
            // Calculate ECDF data points
            const ecdfData = [];
            for (let i = 0; i < points.length; i++) {
                ecdfData.push({
                    x: points[i],
                    y: (i + 1) / points.length
                });
            }
            
            const ctx = document.getElementById('ecdf-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (ecdfChart) {
                ecdfChart.destroy();
            }
            
            ecdfChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'ECDF of Points',
                        data: ecdfData,
                        borderColor: '#0065bd',
                        backgroundColor: 'rgba(0, 101, 189, 0.1)',
                        borderWidth: 2,
                        stepped: true,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }, {
                        label: 'P1 Threshold',
                        data: [{x: currentP1, y: 0}, {x: currentP1, y: 1}],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }, {
                        label: 'P4 Threshold',
                        data: [{x: currentP4, y: 0}, {x: currentP4, y: 1}],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Empirical Cumulative Distribution Function'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Points (pkt)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Cumulative Probability'
                            },
                            min: 0,
                            max: 1
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Phase 3 - F7: Create histogram of grades
        function createHistogramChart() {
            if (gradingData.length === 0) return;
            
            // Count frequency of each grade
            const gradeFrequency = {};
            const possibleGrades = [1.0, 1.3, 1.7, 2.0, 2.3, 2.7, 3.0, 3.3, 3.7, 4.0, 5.0];
            
            // Initialize all grades with 0 count
            possibleGrades.forEach(grade => {
                gradeFrequency[grade] = 0;
            });
            
            // Count actual grades
            gradingData.forEach(student => {
                const grade = student.grade;
                if (gradeFrequency.hasOwnProperty(grade)) {
                    gradeFrequency[grade]++;
                }
            });
            
            // Prepare data for chart
            const labels = possibleGrades.map(grade => grade.toFixed(1));
            const counts = possibleGrades.map(grade => gradeFrequency[grade]);
            
            const ctx = document.getElementById('histogram-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (histogramChart) {
                histogramChart.destroy();
            }
            
            histogramChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Students',
                        data: counts,
                        backgroundColor: labels.map(grade => {
                            const gradeNum = parseFloat(grade);
                            if (gradeNum < 4.15) return 'rgba(40, 167, 69, 0.8)'; // Green for passing
                            else return 'rgba(220, 53, 69, 0.8)'; // Red for failing
                        }),
                        borderColor: labels.map(grade => {
                            const gradeNum = parseFloat(grade);
                            if (gradeNum < 4.15) return '#28a745'; // Green for passing
                            else return '#dc3545'; // Red for failing
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribution of Final Grades'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Grade'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Students'
                            },
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Phase 3 - Update charts when data changes
        function updateCharts() {
            createECDFChart();
            createHistogramChart();
        }

        function calculateRawNote(points, p1, p4) {
            // Linear interpolation formula from requirements:
            // raw_note = 3/(P4 − P1) · pkt + [1 − 3·P1/(P4 − P1)]
            const slope = 3 / (p4 - p1);
            const intercept = 1 - (3 * p1) / (p4 - p1);
            return slope * points + intercept;
        }

        function mapToDiscreteGrade(rawNote) {
            // Apply the R-style function from F4
            for (const mapping of GRADE_CONSTANTS.GRADE_MAPPING) {
                if (rawNote <= mapping.max) {
                    return mapping.grade / 100; // Divide by 100 to get final grade
                }
            }
            return 5.0; // Fallback
        }

        function displayGradingTable(originalHeaders) {
            const container = document.getElementById('grading-table-content');
            
            // Create enhanced headers
            const enhancedHeaders = [...originalHeaders, 'pkt', 'raw_note', 'grade'];
            
            let tableHTML = '<div class="scrollable-table"><table>';
            
            // Header row
            tableHTML += '<thead><tr>';
            enhancedHeaders.forEach((header, index) => {
                const isComputed = index >= originalHeaders.length;
                const className = isComputed ? 'computed-column' : '';
                tableHTML += `<th class="${className}">${header}</th>`;
            });
            tableHTML += '</tr></thead>';
            
            // Data rows
            tableHTML += '<tbody>';
            gradingData.forEach(student => {
                tableHTML += '<tr>';
                
                // Original data columns
                student.originalRow.forEach(value => {
                    tableHTML += `<td>${value !== undefined ? value : ''}</td>`;
                });
                
                // Computed columns
                tableHTML += `<td class="computed-column">${student.pkt.toFixed(1)}</td>`;
                tableHTML += `<td class="computed-column">${student.raw_note.toFixed(2)}</td>`;
                tableHTML += `<td class="computed-column">${student.grade.toFixed(1)}</td>`;
                
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table></div>';
            
            container.innerHTML = tableHTML;
            document.getElementById('grading-table-container').style.display = 'block';
        }

        // Phase 2 - Set dynamic slider ranges based on data
        function setSliderRanges() {
            if (gradingData.length === 0) return;
            
            // Calculate min and max points from the data
            const points = gradingData.map(student => student.pkt);
            const minPoints = Math.min(...points);
            const maxPoints = Math.max(...points);
            
            // Set P1 slider range (should be in upper range of points)
            const p1Min = Math.max(minPoints, Math.ceil(maxPoints * 0.6)); // At least 60% of max points
            const p1Max = Math.max(maxPoints, p1Min + 10); // Ensure some range
            
            // Set P4 slider range (should be in lower range of points, but less than P1)
            const p4Min = Math.max(1, minPoints);
            const p4Max = Math.min(p1Min - 0.5, Math.ceil(maxPoints * 0.8)); // Max 80% of max points, less than P1 min
            
            // Update P1 slider and input
            const p1Slider = document.getElementById('p1-slider');
            const p1Input = document.getElementById('p1-input');
            p1Slider.min = p1Min;
            p1Slider.max = p1Max;
            p1Input.min = p1Min;
            p1Input.max = p1Max;
            
            // Set reasonable default for P1 (around 75% of max points)
            const p1Default = Math.min(p1Max, Math.max(p1Min, Math.ceil(maxPoints * 0.75)));
            p1Slider.value = p1Default;
            p1Input.value = p1Default;
            currentP1 = p1Default;
            document.getElementById('p1-range-info').textContent = `Range: ${p1Min}-${p1Max} points`;
            
            // Update P4 slider and input
            const p4Slider = document.getElementById('p4-slider');
            const p4Input = document.getElementById('p4-input');
            p4Slider.min = p4Min;
            p4Slider.max = p4Max;
            p4Input.min = p4Min;
            p4Input.max = p4Max;
            
            // Set reasonable default for P4 (around 40% of max points)
            const p4Default = Math.min(p4Max, Math.max(p4Min, Math.ceil(maxPoints * 0.4)));
            p4Slider.value = p4Default;
            p4Input.value = p4Default;
            currentP4 = p4Default;
            document.getElementById('p4-range-info').textContent = `Range: ${p4Min}-${p4Max} points`;
            
            console.log(`Data range: ${minPoints}-${maxPoints} points`);
            console.log(`P1 range: ${p1Min}-${p1Max}, default: ${p1Default}`);
            console.log(`P4 range: ${p4Min}-${p4Max}, default: ${p4Default}`);
        }

        // Phase 4 - Combined Process and Copy function
        async function handleProcessAndCopy() {
            const textarea = document.getElementById('student-ids');
            const idsText = textarea.value.trim();
            
            if (!idsText) {
                showError('Please paste student IDs in the textarea');
                return;
            }
            
            if (gradingData.length === 0) {
                showError('Please upload grading data first');
                return;
            }
            
            // Parse the student IDs (one per line)
            studentIdList = idsText.split('\n')
                .map(id => id.trim())
                .filter(id => id.length > 0);
            
            if (studentIdList.length === 0) {
                showError('No valid student IDs found');
                return;
            }
            
            // Create aligned grade data
            alignedGradeData = [];
            studentIdList.forEach(mtknr => {
                const student = gradingData.find(s => s.mtknr == mtknr);
                if (student) {
                    alignedGradeData.push({
                        mtknr: mtknr,
                        grade: student.grade,
                        found: true
                    });
                } else {
                    alignedGradeData.push({
                        mtknr: mtknr,
                        grade: 'not found',
                        found: false
                    });
                }
            });
            
            // Display the aligned table
            displayIdMatchTable();
            
            showInfo('Processed ' + studentIdList.length + ' student IDs (' + alignedGradeData.filter(d => d.found).length + ' matches found). Use the "Copy Grades" button below to copy to clipboard.');
        }

        // Phase 4 - Display the ID-aligned grade table
        function displayIdMatchTable() {
            const container = document.getElementById('id-match-content');
            
            let tableHTML = '<div class="scrollable-table"><table>';
            
            // Header row
            tableHTML += '<thead><tr>';
            tableHTML += '<th>Order</th>';
            tableHTML += '<th>Student ID (mtknr)</th>';
            tableHTML += '<th class="computed-column">Grade</th>';
            tableHTML += '</tr></thead>';
            
            // Data rows
            tableHTML += '<tbody>';
            alignedGradeData.forEach((student, index) => {
                const rowClass = student.found ? '' : 'not-found-row';
                const gradeDisplay = student.found ? student.grade.toFixed(1) : 'not found';
                
                tableHTML += `<tr class="${rowClass}">`;
                tableHTML += `<td>${index + 1}</td>`;
                tableHTML += `<td>${student.mtknr}</td>`;
                tableHTML += `<td class="computed-column">${gradeDisplay}</td>`;
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table></div>';
            
            container.innerHTML = tableHTML;
            document.getElementById('id-match-container').style.display = 'block';
            document.getElementById('copy-aligned-grades-btn').style.display = 'inline-block';
            document.getElementById('copy-all-data-btn').style.display = 'inline-block';
            
            // Phase 5: Update alignment statistics
            updateAlignmentStats();
        }

        // Phase 4 - Copy grades from alignment table
        async function handleCopyAlignedGrades() {
            if (alignedGradeData.length === 0) {
                showError('No aligned grade data available. Please process student IDs first.');
                return;
            }
            
            // Create grade column text (one grade per line)
            const gradeText = alignedGradeData.map(student => {
                return student.found ? student.grade.toFixed(1) : '';
            }).join('\n');
            
            try {
                await navigator.clipboard.writeText(gradeText);
                showInfo('Copied ' + alignedGradeData.length + ' grades to clipboard (empty lines for missing students)');
            } catch (error) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = gradeText;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showInfo('Copied ' + alignedGradeData.length + ' grades to clipboard (empty lines for missing students)');
                } catch (fallbackError) {
                    showError('Failed to copy to clipboard. Please copy manually from the table.');
                }
                document.body.removeChild(textArea);
            }
        }

        // Phase 7 - Copy all data (Student ID + Grade) for archival
        async function handleCopyAllData() {
            if (alignedGradeData.length === 0) {
                showError('No aligned grade data available. Please process student IDs first.');
                return;
            }
            
            // Create tab-separated data with header
            const header = 'Student_ID\tGrade';
            const dataRows = alignedGradeData.map(student => {
                const grade = student.found ? student.grade.toFixed(1) : '';
                return student.mtknr + '\t' + grade;
            });
            
            const allData = [header, ...dataRows].join('\n');
            
            try {
                await navigator.clipboard.writeText(allData);
                showInfo('Copied ' + alignedGradeData.length + ' student records (ID + Grade) to clipboard for archival');
            } catch (error) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = allData;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showInfo('Copied ' + alignedGradeData.length + ' student records (ID + Grade) to clipboard for archival');
                } catch (fallbackError) {
                    showError('Failed to copy to clipboard. Please copy manually from the table.');
                }
                document.body.removeChild(textArea);
            }
        }

        // Phase 5 - Update alignment statistics
        function updateAlignmentStats() {
            if (alignedGradeData.length === 0) return;
            
            // Filter out students that were not found
            const foundStudents = alignedGradeData.filter(student => student.found);
            
            if (foundStudents.length === 0) {
                // No students found, show zeros
                document.getElementById('alignment-mean').textContent = '--';
                document.getElementById('alignment-pass-rate').textContent = '--';
                document.getElementById('alignment-pass-count').textContent = '0';
                document.getElementById('alignment-checksum').textContent = '--';
                document.getElementById('id-match-stats').style.display = 'none';
                return;
            }
            
            // Calculate statistics
            const grades = foundStudents.map(student => student.grade);
            const mean = grades.reduce((sum, grade) => sum + grade, 0) / grades.length;
            const passCount = grades.filter(grade => grade <= 4.0).length;
            const passRate = (passCount / grades.length) * 100;
            
            // Calculate checksum: average of (studentId * grade) for found students
            const checksumSum = foundStudents.reduce((sum, student) => {
                const id = parseInt(student.mtknr) || 0;
                return sum + (id * student.grade);
            }, 0);
            const checksum = checksumSum / foundStudents.length;
            
            // Update display
            document.getElementById('alignment-mean').textContent = mean.toFixed(2);
            document.getElementById('alignment-pass-rate').textContent = passRate.toFixed(1) + '%';
            document.getElementById('alignment-pass-count').textContent = `${passCount}/${foundStudents.length}`;
            document.getElementById('alignment-checksum').textContent = checksum.toFixed(0);
            
            // Update Excel formula with dynamic range
            updateExcelFormula();
            
            // Show the statistics section
            document.getElementById('id-match-stats').style.display = 'block';
        }

        // Phase 5 - Update Excel formula with correct cell range
        function updateExcelFormula() {
            if (alignedGradeData.length === 0) return;
            
            // Calculate the range based on the data
            // Assume Excel starts at row 6 (typical for a table with headers)
            const startRow = 6;
            const endRow = startRow + alignedGradeData.length - 1;
            
            // Generate formula: =AVERAGE(F6:F20 * G6:G20) where F=IDs, G=Grades
            const formula = `=AVERAGE(F${startRow}:F${endRow} * G${startRow}:G${endRow})`;
            
            document.getElementById('excel-formula').value = formula;
        }

        // Phase 5 - Copy Excel formula to clipboard
        async function handleCopyFormula() {
            const formulaInput = document.getElementById('excel-formula');
            const formula = formulaInput.value;
            
            try {
                await navigator.clipboard.writeText(formula);
                showInfo('Excel formula copied to clipboard!');
            } catch (error) {
                // Fallback for older browsers
                formulaInput.select();
                try {
                    document.execCommand('copy');
                    showInfo('Excel formula copied to clipboard!');
                } catch (fallbackError) {
                    showError('Failed to copy formula to clipboard. Please copy manually.');
                }
            }
        }

        // Utility functions
        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = '<div class="error">Error: ' + message + '</div>';
        }

        function showInfo(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = '<div class="info">' + message + '</div>';
        }

        function clearErrors() {
            document.getElementById('error-container').innerHTML = '';
        }
        
        // Phase 5 - Number input change handler
        function handleInputChange(event) {
            const inputId = event.target.id;
            const value = parseFloat(event.target.value);
            
            // Validate input
            if (isNaN(value)) return;
            
            if (inputId === 'p1-input') {
                const p1Slider = document.getElementById('p1-slider');
                const p4Slider = document.getElementById('p4-slider');
                const p4Input = document.getElementById('p4-input');
                
                // Ensure value is within slider bounds
                const clampedValue = Math.max(parseFloat(p1Slider.min), Math.min(parseFloat(p1Slider.max), value));
                
                // Ensure P1 > P4
                if (clampedValue <= currentP4) {
                    return; // Don't allow P1 to be <= P4
                }
                
                currentP1 = clampedValue;
                p1Slider.value = currentP1;
                event.target.value = currentP1;
                
                // Update P4 constraints
                const newP4Max = Math.min(parseFloat(p4Slider.max), currentP1 - 0.5);
                if (currentP4 >= currentP1) {
                    currentP4 = newP4Max;
                    p4Slider.value = currentP4;
                    p4Input.value = currentP4;
                }
                p4Slider.max = newP4Max;
                p4Input.max = newP4Max;
                document.getElementById('p4-range-info').textContent = `Range: ${p4Slider.min}-${newP4Max} points`;
                
            } else if (inputId === 'p4-input') {
                const p4Slider = document.getElementById('p4-slider');
                const p1Slider = document.getElementById('p1-slider');
                const p1Input = document.getElementById('p1-input');
                
                // Ensure value is within slider bounds
                const clampedValue = Math.max(parseFloat(p4Slider.min), Math.min(parseFloat(p4Slider.max), value));
                
                // Ensure P4 < P1
                if (clampedValue >= currentP1) {
                    return; // Don't allow P4 to be >= P1
                }
                
                currentP4 = clampedValue;
                p4Slider.value = currentP4;
                event.target.value = currentP4;
                
                // Update P1 constraints
                const newP1Min = Math.max(parseFloat(p1Slider.min), currentP4 + 0.5);
                if (currentP1 <= currentP4) {
                    currentP1 = newP1Min;
                    p1Slider.value = currentP1;
                    p1Input.value = currentP1;
                }
                p1Slider.min = newP1Min;
                p1Input.min = newP1Min;
                document.getElementById('p1-range-info').textContent = `Range: ${newP1Min}-${p1Slider.max} points`;
            }
            
            // Recalculate grades if data is loaded
            if (gradingData.length > 0) {
                calculateGrades();
                updateGradingTable();
                updateSummaryStats();
                updateCharts(); // Phase 3: Update charts
            }
        }
    </script>
</body>
</html>
